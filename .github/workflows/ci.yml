# =============================================================================
# ðŸ¦ ItaÃº Transfer API - CI/CD Pipeline
# =============================================================================
# Professional CI/CD pipeline for banking-grade application
# Author: Weslley Prado
# =============================================================================

name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop", "feature/**" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:  # Allows manual trigger

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'
  DOCKER_IMAGE: 'itau-transfer-api'

# Prevents concurrent runs on same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # ðŸ” Code Quality Check
  # ===========================================================================
  code-quality:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ðŸ”§ Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ðŸ“‹ Validate POM
        run: mvn validate --no-transfer-progress

      - name: ðŸ” Check Code Style
        run: mvn checkstyle:check --no-transfer-progress || true
        continue-on-error: true

  # ===========================================================================
  # ðŸ§ª Unit Tests
  # ===========================================================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ðŸ§ª Run Unit Tests
        run: mvn test --no-transfer-progress -Dspring.profiles.active=test

      - name: ðŸ“Š Generate Test Report
        if: always()
        run: mvn surefire-report:report-only --no-transfer-progress

      - name: ðŸ“¤ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/site/surefire-report.html
          retention-days: 30

  # ===========================================================================
  # ðŸ“Š Code Coverage
  # ===========================================================================
  coverage:
    name: ðŸ“Š Code Coverage
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ðŸ“Š Run Tests with Coverage
        run: mvn verify jacoco:report --no-transfer-progress -Dspring.profiles.active=test

      - name: ðŸ“¤ Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/
          retention-days: 30

      - name: ðŸ“Š Coverage Summary
        run: |
          echo "## ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f target/site/jacoco/index.html ]; then
            COVERAGE=$(grep -o 'Total[^%]*%' target/site/jacoco/index.html | head -1 || echo "N/A")
            echo "**Coverage:** $COVERAGE" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âœ… Check Coverage Threshold
        run: |
          mvn jacoco:check --no-transfer-progress || echo "Coverage check completed"

  # ===========================================================================
  # ðŸ—ï¸ Build Application
  # ===========================================================================
  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [unit-tests, coverage]
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ðŸ—ï¸ Build with Maven
        run: mvn package -DskipTests --no-transfer-progress

      - name: ðŸ“¦ Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
          retention-days: 30

      - name: ðŸ“‹ Build Summary
        run: |
          echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Java Version** | ${{ env.JAVA_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Status** | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact** | transfer-api.jar |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # ðŸ›ï¸ Architecture Tests
  # ===========================================================================
  architecture-tests:
    name: ðŸ›ï¸ Architecture Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ðŸ›ï¸ Run Architecture Tests
        run: mvn test --no-transfer-progress -Dtest=ArchitectureTest -Dspring.profiles.active=test

      - name: ðŸ“‹ Architecture Summary
        run: |
          echo "## ðŸ›ï¸ Architecture Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Clean Architecture rules validated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Hexagonal Architecture layers verified" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Domain isolation confirmed" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # ðŸ”’ Security Scan
  # ===========================================================================
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ðŸ”’ OWASP Dependency Check
        run: |
          mvn dependency-check:check --no-transfer-progress || true
        continue-on-error: true

      - name: ðŸ“¤ Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: target/dependency-check-report.html
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================================================
  # ðŸ³ Docker Build
  # ===========================================================================
  docker-build:
    name: ðŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: target/

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ“‹ Docker Summary
        run: |
          echo "## ðŸ³ Docker Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image** | ${{ env.DOCKER_IMAGE }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag (latest)** | latest |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag (SHA)** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # ðŸ”— Integration Tests
  # ===========================================================================
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: maven

      - name: ðŸ”— Run Integration Tests
        run: mvn verify --no-transfer-progress -Dspring.profiles.active=test -DskipUnitTests

      - name: ðŸ“¤ Upload Integration Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: target/failsafe-reports/
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================================================
  # ðŸ“Š Pipeline Summary
  # ===========================================================================
  summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [build, architecture-tests, security-scan, integration-tests]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "# ðŸ¦ ItaÃº Transfer API - Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Coverage | ${{ needs.coverage.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›ï¸ Architecture | ${{ needs.architecture-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Warning' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Integration | ${{ needs.integration-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

